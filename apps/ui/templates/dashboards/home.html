{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<h3 class="page-title mb-3">
  <span class="dot"><i class="bi bi-speedometer2"></i></span>
  Dashboard
</h3>

<style>
  /* -------- KPI plus compacts + bordure d’accent -------- */
  .metrics-grid{
    display:grid; gap:12px;
    grid-template-columns: repeat(12, 1fr);
  }
  .metric-card{
    grid-column: span 3;
    position: relative;
    background:#fff;
    border-radius: 18px;
    border:1px solid #e9eef5;
    box-shadow: var(--ring);
    padding: 16px 16px 14px 18px;
    min-height: 120px;
    overflow: hidden;
  }
  .metric-card::after{
    content:""; position:absolute; inset:-1px auto -1px -1px;
    width:8px; border-radius:18px 0 0 18px;
  }
  .metric-card.ac-blue::after   { background: linear-gradient(180deg,#3b82f6 0%, #1d4ed8 100%); }
  .metric-card.ac-green::after  { background: linear-gradient(180deg,#16a34a 0%, #0f7a36 100%); }
  .metric-card.ac-orange::after { background: linear-gradient(180deg,#f59e0b 0%, #f97316 100%); }
  .metric-card.ac-pink::after   { background: linear-gradient(180deg,#db2777 0%, #f43f5e 100%); }

  .metric-card .icon{
    width:44px;height:44px;border-radius:14px;
    display:flex;align-items:center;justify-content:center;
    color:#fff; font-size:20px; margin-bottom:8px;
  }
  .icon.blue{   background: linear-gradient(135deg,#3b82f6,#2563eb); }
  .icon.green{  background: linear-gradient(135deg,#16a34a,#22c55e); }
  .icon.orange{ background: linear-gradient(135deg,#f59e0b,#f97316); }
  .icon.pink{   background: linear-gradient(135deg,#db2777,#f43f5e); }

  .metric-card .value{ font-weight:800; font-size:1.8rem; line-height:1; }
  .metric-card .label{ color:#6b7280; font-size:.95rem; margin-top:6px; }

  /* -------- Carrousel & filtres -------- */
  .carousel-shell { position: relative; }
  .carousel-wrap   { overflow: hidden; }
  .carousel-track  { display: flex; gap: 12px; }
  .cat-card        { min-width: 330px; max-width: 330px; flex: 0 0 330px; }
  .carousel-nav {
    position: absolute; top: 50%; transform: translateY(-50%);
    width: 36px; height: 36px; border-radius: 999px;
    display: grid; place-items: center; background: #fff; box-shadow: var(--ring);
    border: 1px solid #e9ecef; color:#111827; cursor: pointer;
  }
  .carousel-prev { left: -12px; }
  .carousel-next { right: -12px; }
  .carousel-nav[disabled] { opacity: .35; pointer-events: none; }

  .mini-muted { color:#6b7280; }
  .badge-status { font-weight: 600; }
  .filters .btn-soft.active { background:#1f6feb14; border-color:#1f6feb30; }
  .dropdown-menu .dropdown-item.active, .dropdown-menu .dropdown-item:active { background-color: #0d6efd; }
</style>

<form method="get" class="filters p-3 mb-3" id="periodForm">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Du</label>
      <input type="date" name="start" class="form-control" value="{{ start|date:'Y-m-d' }}">
    </div>

    <div class="col-md-3">
      <label class="form-label">Au</label>
      <input type="date" name="end" class="form-control" value="{{ end|date:'Y-m-d' }}">
    </div>

    {% if request.user.is_staff %}
      <div class="col-md-3">
        <label class="form-label">Utilisateur</label>
        <select name="owner" class="form-select">
          <option value="">Tous</option>
          {% for u in owners %}
            <option value="{{ u.id }}" {% if selected_owner == u.id|stringformat:"s" %}selected{% endif %}>{{ u.username }}</option>
          {% endfor %}
        </select>
      </div>
    {% endif %}

    <!-- Ligne Catégorie + Magasin + Boutons -->
    <div class="col-12">
      <label class="form-label d-block">Catégorie</label>

      <div class="d-flex flex-wrap align-items-center gap-2">
        <a class="btn btn-soft {% if not selected_category %}active{% endif %}"
           href="?start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}{% if selected_store %}&store={{ selected_store }}{% endif %}{% if selected_owner %}&owner={{ selected_owner }}{% endif %}">
          Toutes
        </a>
        {% for c in categories %}
          <a class="btn btn-soft {% if selected_category == c.id|stringformat:'s' %}active{% endif %}"
             href="?start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}&category={{ c.id }}{% if selected_store %}&store={{ selected_store }}{% endif %}{% if selected_owner %}&owner={{ selected_owner }}{% endif %}">
            {{ c.name }}
          </a>
        {% endfor %}

        <div class="dropdown ms-1">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="storeMenuBtn" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="bi bi-shop me-1"></i>
            {% if selected_store %}
              {% for s in stores %}{% if s.code == selected_store %}{{ s.code }}{% if s.name %} — {{ s.name }}{% endif %}{% endif %}{% endfor %}
            {% else %}Magasin{% endif %}
          </button>
          <ul class="dropdown-menu" aria-labelledby="storeMenuBtn" style="max-height: 360px; overflow:auto;">
            <li><a class="dropdown-item {% if not selected_store %}active{% endif %}" href="#" data-store="">Tous les magasins</a></li>
            <li><hr class="dropdown-divider"></li>
            {% for s in stores %}
              <li>
                <a class="dropdown-item {% if selected_store == s.code %}active{% endif %}" href="#" data-store="{{ s.code }}">
                  {{ s.code }}{% if s.name %} — {{ s.name }}{% endif %}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>

        <div class="ms-auto d-flex gap-2 mt-2 mt-md-0">
          <button class="btn btn-primary" type="submit">Appliquer</button>
          <a href="{% url 'ui:home' %}" class="btn btn-outline-secondary">Réinitialiser</a>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- KPI globaux (compacts) -->
<div class="metrics-grid mb-3">
  <div class="metric-card ac-blue">
    <div class="icon blue"><i class="bi bi-collection"></i></div>
    <div class="value">{{ kpis.total }}</div>
    <div class="label">Comparatifs</div>
  </div>
  <div class="metric-card ac-green">
    <div class="icon green"><i class="bi bi-check2-circle"></i></div>
    <div class="value">{{ kpis.success }}</div>
    <div class="label">Succès</div>
  </div>
  <div class="metric-card ac-pink">
    <div class="icon pink"><i class="bi bi-x-circle"></i></div>
    <div class="value">{{ kpis.failed }}</div>
    <div class="label">Échecs</div>
  </div>
  <div class="metric-card ac-orange">
    <div class="icon orange"><i class="bi bi-graph-up-arrow"></i></div>
    <div class="value">{{ kpis.diffs }}</div>
    <div class="label">Écarts cumulés</div>
  </div>
</div>

<!-- Carrousel catégories -->
<div class="carousel-shell mb-3">
  <button type="button" class="carousel-nav carousel-prev" id="catPrev" aria-label="Précédent"><i class="bi bi-chevron-left"></i></button>
  <div class="carousel-wrap" id="catWrap">
    <div class="carousel-track" id="catTrack" data-visible="3">
      {% for c in cat_summary %}
        <div class="p-3 rounded-3 bg-white cat-card" style="box-shadow:var(--ring);">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-bold">{{ c.name }}</div>
            <a class="btn btn-soft btn-sm"
               href="{% url 'comparisons:runs_dashboard' %}?category={{ c.id }}{% if selected_store %}&store={{ selected_store }}{% endif %}{% if start %}&start={{ start|date:'Y-m-d' }}{% endif %}{% if end %}&end={{ end|date:'Y-m-d' }}{% endif %}{% if selected_owner %}&owner={{ selected_owner }}{% endif %}">
              Voir
            </a>
          </div>

          <div class="mt-2 mini-muted small d-flex gap-3 flex-wrap">
            <span>Runs: <strong>{{ c.runs }}</strong></span>
            <span>Succès: <strong>{{ c.success }}</strong></span>
            <span>Échecs: <strong>{{ c.failed }}</strong></span>
            <span>Écarts: <strong>{{ c.diffs }}</strong></span>
          </div>

          <!-- Créé par / Badge sur la même ligne -->
          <div class="mt-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="mini-muted small">
              Créé par :
              <strong>{% firstof c.created_by c.last_owner "—" %}</strong>
            </div>
            <div>
              {% if c.runs and not c.diffs %}
                <span class="badge badge-status badge-success">Intégrité OK</span>
                <span class="mini-muted small">({{ c.integrated_runs }} run(s) sans écart)</span>
              {% elif c.runs %}
                <span class="badge badge-status badge-failed">Écarts détectés</span>
              {% else %}
                <span class="badge badge-status badge-running">Aucune vérification</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  <button type="button" class="carousel-nav carousel-next" id="catNext" aria-label="Suivant"><i class="bi bi-chevron-right"></i></button>
</div>

<!-- Mini KPI par magasin -->
{% if per_store %}
<div class="row g-3 mb-3">
  {% for s in per_store %}
    <div class="col-md-4">
      <div class="p-3 rounded-3 bg-white" style="box-shadow:var(--ring);">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">{{ s.code }}{% if s.name %} — {{ s.name }}{% endif %}</div>
          <a class="btn btn-soft btn-sm"
             href="{% url 'comparisons:runs_dashboard' %}?store={{ s.code }}{% if selected_category %}&category={{ selected_category }}{% endif %}&start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}{% if selected_owner %}&owner={{ selected_owner }}{% endif %}">
            Voir
          </a>
        </div>

        <div class="mt-2 mini-muted small d-flex gap-3 flex-wrap">
          <span>Runs: <strong>{{ s.runs }}</strong></span>
          <span>Succès: <strong>{{ s.success }}</strong></span>
          <span>Échecs: <strong>{{ s.failed }}</strong></span>
          <span>Écarts: <strong>{{ s.diffs }}</strong></span>
        </div>

        <!-- Créé par / Badge sur la même ligne -->
        <div class="mt-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="mini-muted small">
            Créé par :
            <strong>{% firstof s.created_by s.last_owner "—" %}</strong>
          </div>
          <div>
            {% if s.runs and not s.diffs %}
              <span class="badge badge-status badge-success">Intégrité OK</span>
            {% elif s.runs %}
              <span class="badge badge-status badge-failed">Écarts détectés</span>
            {% else %}
              <span class="badge badge-status badge-running">Aucune vérification</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endif %}

<!-- Graphiques -->
<div class="row g-3">
  <div class="col-lg-8">
    <div class="filters p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0 fw-bold"><i class="bi bi-graph-up me-2"></i>Tendance mensuelle</h6>
      </div>
      {% if has_line_data %}
        <canvas id="lineChart" height="96"></canvas>
      {% else %}
        <div class="empty-card"><i class="bi bi-graph-up"></i><div class="title">Aucune donnée</div><div class="hint">Lance des comparatifs pour voir l’évolution mensuelle.</div></div>
      {% endif %}
    </div>
  </div>

  <div class="col-lg-3">
    <div class="filters p-3">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0 fw-bold"><i class="bi bi-pie-chart me-2"></i>Répartition par statut</h6>
      </div>
      {% if has_donut_data %}
        <div class="position-relative" style="width:100%; max-width:520px;">
          <canvas id="donutChart" height="128"></canvas>
        </div>
      {% else %}
        <div class="empty-card"><i class="bi bi-pie-chart"></i><div class="title">Aucune donnée</div><div class="hint">Les statuts apparaîtront après tes premières vérifications.</div></div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Activité récente -->
<div class="row g-4 mt-4">
  <div class="col-lg-8">
    <div class="filters p-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0 fw-bold"><i class="bi bi-clock-history me-2"></i>Dernières vérifications</h6>
        <a class="btn btn-soft btn-sm"
           href="{% url 'comparisons:runs_dashboard' %}?{% if selected_category %}category={{ selected_category }}&{% endif %}{% if selected_store %}store={{ selected_store }}&{% endif %}{% if selected_owner %}owner={{ selected_owner }}&{% endif %}start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}">
          Voir tout
        </a>
      </div>

      <div class="activity-list">
        {% for r in recent_runs %}
          <div class="activity-item">
            <div class="activity-icon"><i class="bi bi-rocket-takeoff"></i></div>
            <div class="activity-body">
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-semibold">{{ r.config.category.name }} — {{ r.config.name }} <span class="text-muted">(#{{ r.id }})</span></div>
                <div class="small text-muted">{{ r.created_at|timesince }} ago</div>
              </div>

              <div class="mt-1 d-flex align-items-center gap-2 flex-wrap">
                <!-- Créé par -->
                <span class="mini-muted small me-2">Créé par : <strong>{{ r.config.owner.username }}</strong></span>

                {% if r.status == "success" %}
                  <span class="badge badge-status badge-success">success</span>
                {% elif r.status == "failed" %}
                  <span class="badge badge-status badge-failed">failed</span>
                {% else %}
                  <span class="badge badge-status badge-running">{{ r.status }}</span>
                {% endif %}

                <span class="text-muted small">Écarts: <strong>{{ r.diff_rows }}</strong></span>
                <a class="btn btn-soft btn-sm" href="{% url 'comparisons:results' r.id %}"><i class="bi bi-eye"></i> Détails</a>
                {% if r.export_csv %}<a class="btn btn-soft btn-sm" href="{{ r.export_csv }}"><i class="bi bi-filetype-csv"></i> CSV</a>{% endif %}
                {% if r.export_xlsx %}<a class="btn btn-soft btn-sm" href="{{ r.export_xlsx }}"><i class="bi bi-filetype-xlsx"></i> XLSX</a>{% endif %}
              </div>
            </div>
          </div>
        {% empty %}
          <div class="text-muted">Aucune vérification récente.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="filters p-3">
      <h6 class="mb-2 fw-bold"><i class="bi bi-lightbulb me-2"></i>Suivi & Conseils</h6>
      <p class="small text-muted mb-2">Utilise des <strong>clés composites</strong> pour fiabiliser tes rapprochements (Référence, Date, Magasin…).</p>
      <p class="small text-muted mb-0">Après une vérification <em>sans écart</em>, la catégorie est marquée <strong>Intégrité OK</strong>.</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  // Charts
  const labels = {{ labels_json|safe }};
  const runsSeries = {{ runs_series_json|safe }};
  const diffsSeries = {{ diffs_series_json|safe }};
  const statusLabels = {{ status_labels_json|safe }};
  const statusValues = {{ status_values_json|safe }};

  const lineEl = document.getElementById('lineChart');
  if (lineEl && {{ has_line_data|yesno:"true,false" }}) {
    new Chart(lineEl, { type: 'line',
      data: { labels, datasets: [
        { label: 'Runs', data: runsSeries, tension: .35 },
        { label: 'Écarts', data: diffsSeries, tension: .35 }
      ]},
      options: { responsive:true, plugins:{ legend:{ position:'top' } }, scales:{ y:{ beginAtZero:true } } }
    });
  }

  const donutEl = document.getElementById('donutChart');
  if (donutEl && {{ has_donut_data|yesno:"true,false" }}) {
    new Chart(donutEl, { type: 'doughnut',
      data: { labels: statusLabels, datasets: [{ data: statusValues }] },
      options: { cutout:'60%', plugins:{ legend:{ position:'bottom' } } }
    });
  }

  // Carrousel
  const wrap = document.getElementById('catWrap');
  const track = document.getElementById('catTrack');
  const prev = document.getElementById('catPrev');
  const next = document.getElementById('catNext');
  function updateArrows() {
    const maxScroll = track.scrollWidth - wrap.clientWidth - 2;
    prev.toggleAttribute('disabled', wrap.scrollLeft <= 0);
    next.toggleAttribute('disabled', wrap.scrollLeft >= maxScroll);
  }
  function scrollByPage(dir) {
    const card = track.querySelector('.cat-card'); if (!card) return;
    const visible = Number(track.dataset.visible || 3);
    const amount = (card.offsetWidth + 12) * visible;
    wrap.scrollBy({ left: dir * amount, behavior: 'smooth' });
    setTimeout(updateArrows, 300);
  }
  if (prev && next) {
    prev.addEventListener('click', () => scrollByPage(-1));
    next.addEventListener('click', () => scrollByPage(1));
    wrap.addEventListener('scroll', updateArrows, { passive: true });
    setTimeout(updateArrows, 60);
  }

  // Menu Magasin : conserve owner/category dans l’URL
  const storeItems = document.querySelectorAll('.dropdown-menu [data-store]');
  function navigateWithStore(storeCode) {
    const params = new URLSearchParams(window.location.search);
    const start = params.get('start') || '{{ start|date:"Y-m-d" }}';
    const end   = params.get('end')   || '{{ end|date:"Y-m-d" }}';
    const cat   = params.get('category') || '{{ selected_category|default_if_none:"" }}';
    const owner = params.get('owner') || '{{ selected_owner|default_if_none:"" }}';

    const p = new URLSearchParams();
    if (start) p.set('start', start);
    if (end)   p.set('end', end);
    if (cat)   p.set('category', cat);
    if (owner) p.set('owner', owner);
    if (storeCode) p.set('store', storeCode);

    window.location.href = `${window.location.pathname}?${p.toString()}`;
  }
  storeItems.forEach(it => {
    it.addEventListener('click', (e) => { e.preventDefault(); navigateWithStore(it.getAttribute('data-store')); });
  });
</script>

{% endblock %}
