{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<h3 class="page-title mb-3">
  <span class="dot"><i class="bi bi-speedometer2"></i></span>
  Dashboard
</h3>

<style>
  :root{
    --ink:#0f172a; --ink-2:#1f2937;
    --muted:#6b7280; --line:#e5e7eb; --soft:#f8fafc;
    --brand:#2563eb; --brand-2:#1d4ed8;
    --card:#ffffff; --ring: 0 10px 26px rgba(2,6,23,.06); --radius:18px;
  }
  .page-title{display:flex;align-items:center;gap:.6rem;font-weight:800;color:var(--ink)}
  .page-title .dot{display:grid;place-items:center;width:36px;height:36px;border-radius:12px;background:#e0ecff;color:#1e40af}

  .filters{background:var(--card);border:1px solid #e9eef5;border-radius:var(--radius);box-shadow:var(--ring)}
  .filters .form-label{font-weight:700;color:var(--ink-2)}
  .btn-soft{border:1px solid #e7e9ee;background:#fbfcfe;color:#334155;border-radius:12px;transition:.15s ease}
  .btn-soft:hover{background:#f2f5fb}
  .filters .btn-soft.active{background:#ecf2ff;border-color:#d0ddff;color:#143c8b;box-shadow:inset 0 1px 0 #fff}

  /* KPI */
  .metrics-grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .metric-card{grid-column:span 3;position:relative;background:#fff;border:1px solid #e9eef5;border-radius:var(--radius);box-shadow:var(--ring);padding:16px 16px 14px 18px;min-height:120px;overflow:hidden}
  @media (max-width:991.98px){.metric-card{grid-column:span 6}}
  @media (max-width:575.98px){.metric-card{grid-column:span 12}}
  .metric-card::after{content:"";position:absolute;inset:-1px auto -1px -1px;width:8px;border-radius:var(--radius) 0 0 var(--radius)}
  .metric-card.ac-blue::after{background:linear-gradient(180deg,#3b82f6,#1d4ed8)}
  .metric-card.ac-green::after{background:linear-gradient(180deg,#16a34a,#0f7a36)}
  .metric-card.ac-orange::after{background:linear-gradient(180deg,#f59e0b,#f97316)}
  .metric-card.ac-pink::after{background:linear-gradient(180deg,#db2777,#f43f5e)}
  .metric-card .icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;margin-bottom:8px}
  .icon.blue{background:linear-gradient(135deg,#3b82f6,#2563eb)}
  .icon.green{background:linear-gradient(135deg,#16a34a,#22c55e)}
  .icon.orange{background:linear-gradient(135deg,#f59e0b,#f97316)}
  .icon.pink{background:linear-gradient(135deg,#db2777,#f43f5e)}
  .metric-card .value{font-weight:800;font-size:1.9rem;line-height:1;color:var(--ink)}
  .metric-card .label{color:#6b7280;font-size:.95rem;margin-top:6px}

  /* Carrousel / cartes */
  .carousel-shell{position:relative}.carousel-wrap{overflow:hidden}.carousel-track{display:flex;gap:12px}
  .cat-card{min-width:330px;max-width:330px;flex:0 0 330px;background:#fff;border-radius:var(--radius);box-shadow:var(--ring);border:1px solid #e9eef5}
  .carousel-nav{position:absolute;top:50%;transform:translateY(-50%);width:36px;height:36px;border-radius:999px;display:grid;place-items:center;background:#fff;box-shadow:var(--ring);border:1px solid #e9ecef;color:#111827;cursor:pointer}
  .carousel-prev{left:-12px}.carousel-next{right:-12px}.carousel-nav[disabled]{opacity:.35;pointer-events:none}

  .badge-status{border-radius:10px;padding:.2rem .5rem;font-weight:700}
  .badge-success{background:#ecfdf5;color:#047857;border:1px solid #bbf7d0}
  .badge-failed{background:#fef2f2;color:#b91c1c;border:1px solid #fecaca}
  .badge-running{background:#fff7ed;color:#a16207;border:1px solid #fde68a}
  .empty-card{background:#fff;border:1px solid #e9eef5;border-radius:var(--radius);box-shadow:var(--ring);padding:24px;text-align:center;color:var(--muted)}
  .empty-card .title{font-weight:700;color:var(--ink-2)}
  .mini-muted{color:var(--muted)}
  .activity-list{display:flex;flex-direction:column;gap:12px}
  .activity-item{display:flex;gap:12px;align-items:flex-start;background:#fff;border:1px solid #e9eef5;border-radius:14px;padding:12px 14px;box-shadow:var(--ring)}
  .activity-icon{width:36px;height:36px;border-radius:10px;display:grid;place-items:center;color:#1e3a8a;background:#e0ecff}

  /* === Charts : dynamiques ===
     - par défaut (pas de données) : pas d’alignement forcé → cartes compactes
     - si au moins un graphe : .chart-row.has-chart aligne les colonnes et .chart-card.has-chart a une min-height */
  .chart-row{align-items:flex-start}
  .chart-row.has-chart{align-items:stretch}
  .chart-card{display:flex;flex-direction:column}
  .chart-card.has-chart{min-height:420px}
  .chart-holder{position:relative}
  .chart-card.has-chart .chart-holder{flex:1 1 auto}
  .chart-holder canvas{position:absolute;inset:0;width:100% !important;height:100% !important}
</style>

<form method="get" class="filters p-3 mb-3" id="periodForm">
  <div class="row g-3 align-items-end">
    <div class="col-md-3">
      <label class="form-label">Du</label>
      <input type="date" name="start" class="form-control" value="{{ start|date:'Y-m-d' }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Au</label>
      <input type="date" name="end" class="form-control" value="{{ end|date:'Y-m-d' }}">
    </div>
    {% if request.user.is_staff %}
      <div class="col-md-3">
        <label class="form-label">Utilisateur</label>
        <select name="owner" class="form-select">
          <option value="">Tous</option>
          {% for u in owners %}
            <option value="{{ u.id }}" {% if selected_owner == u.id|stringformat:"s" %}selected{% endif %}>{{ u.username }}</option>
          {% endfor %}
        </select>
      </div>
    {% endif %}

    <div class="col-12">
      <label class="form-label d-block">Catégorie</label>
      <div class="d-flex flex-wrap align-items-center gap-2">
        <a class="btn btn-soft {% if not selected_category %}active{% endif %}"
           href="?start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}{% if selected_store %}&store={{ selected_store }}{% endif %}{% if selected_owner %}&owner={{ selected_owner }}{% endif %}">
          Toutes
        </a>
        {% for c in categories %}
          <a class="btn btn-soft {% if selected_category == c.id|stringformat:'s' %}active{% endif %}"
             href="?start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}&category={{ c.id }}{% if selected_store %}&store={{ selected_store }}{% endif %}{% if selected_owner %}&owner={{ selected_owner }}{% endif %}">
            {{ c.name }}
          </a>
        {% endfor %}

        <div class="dropdown ms-1">
          <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="storeMenuBtn" data-bs-toggle="dropdown">
            <i class="bi bi-shop me-1"></i>
            {% if selected_store %}
              {% for s in stores %}{% if s.code == selected_store %}{{ s.code }}{% if s.name %} — {{ s.name }}{% endif %}{% endif %}{% endfor %}
            {% else %}Magasin{% endif %}
          </button>
          <ul class="dropdown-menu" aria-labelledby="storeMenuBtn" style="max-height:360px;overflow:auto;">
            <li><a class="dropdown-item {% if not selected_store %}active{% endif %}" href="#" data-store="">Tous les magasins</a></li>
            <li><hr class="dropdown-divider"></li>
            {% for s in stores %}
              <li><a class="dropdown-item {% if selected_store == s.code %}active{% endif %}" href="#" data-store="{{ s.code }}">{{ s.code }}{% if s.name %} — {{ s.name }}{% endif %}</a></li>
            {% endfor %}
          </ul>
        </div>

        <div class="ms-auto d-flex gap-2 mt-2 mt-md-0">
          <button class="btn btn-primary" type="submit">Appliquer</button>
          <a href="{% url 'ui:home' %}" class="btn btn-outline-secondary">Réinitialiser</a>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- KPI -->
<div class="metrics-grid mb-3">
  <div class="metric-card ac-blue"><div class="icon blue"><i class="bi bi-collection"></i></div><div class="value">{{ kpis.total }}</div><div class="label">Comparatifs</div></div>
  <div class="metric-card ac-green"><div class="icon green"><i class="bi bi-check2-circle"></i></div><div class="value">{{ kpis.success }}</div><div class="label">Succès</div></div>
  <div class="metric-card ac-pink"><div class="icon pink"><i class="bi bi-x-circle"></i></div><div class="value">{{ kpis.failed }}</div><div class="label">Échecs</div></div>
  <div class="metric-card ac-orange"><div class="icon orange"><i class="bi bi-graph-up-arrow"></i></div><div class="value">{{ kpis.diffs }}</div><div class="label">Écarts cumulés</div></div>
</div>

<!-- Graphiques — dynamiques -->
<div class="row g-3 chart-row {% if has_line_data or has_donut_data %}has-chart{% endif %}">
  <div class="col-lg-8 d-flex">
    <div class="filters p-3 chart-card w-100 {% if has_line_data %}has-chart{% endif %}">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0 fw-bold"><i class="bi bi-graph-up me-2"></i>Tendance mensuelle</h6>
      </div>
      {% if has_line_data %}
        <div class="chart-holder"><canvas id="lineChart"></canvas></div>
      {% else %}
        <div class="empty-card">
          <i class="bi bi-graph-up"></i>
          <div class="title">Aucune donnée</div>
          <div class="hint">Lance des comparatifs pour voir l’évolution mensuelle.</div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="col-lg-4 d-flex">
    <div class="filters p-3 chart-card w-100 {% if has_donut_data %}has-chart{% endif %}">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0 fw-bold"><i class="bi bi-pie-chart me-2"></i>Répartition par statut</h6>
      </div>
      {% if has_donut_data %}
        <div class="chart-holder"><canvas id="donutChart"></canvas></div>
      {% else %}
        <div class="empty-card">
          <i class="bi bi-pie-chart"></i>
          <div class="title">Aucune donnée</div>
          <div class="hint">Les statuts apparaîtront après tes premières vérifications.</div>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Mini KPI par magasin -->
{% if per_store %}
<br/>
<div class="row g-3 mb-3">
  {% for s in per_store %}
    <div class="col-md-4">
      <div class="p-3 rounded-3 bg-white" style="box-shadow:var(--ring);border:1px solid #e9eef5;">
        <div class="d-flex justify-content-between align-items-center">
          <div class="fw-bold">{{ s.code }}{% if s.name %} — {{ s.name }}{% endif %}</div>
          <a class="btn btn-soft btn-sm"
             href="{% url 'comparisons:runs_dashboard' %}?store={{ s.code }}{% if selected_category %}&category={{ selected_category }}{% endif %}&start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}{% if selected_owner %}&owner={{ selected_owner }}{% endif %}">
            Voir
          </a>
        </div>
        <div class="mt-2 mini-muted small d-flex gap-3 flex-wrap">
          <span>Runs: <strong>{{ s.runs }}</strong></span>
          <span>Succès: <strong>{{ s.success }}</strong></span>
          <span>Échecs: <strong>{{ s.failed }}</strong></span>
          <span>Écarts: <strong>{{ s.diffs }}</strong></span>
        </div>
        <div class="mt-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="mini-muted small">Créé par : <strong>{% firstof s.created_by s.last_owner "—" %}</strong></div>
          <div>
            {% if s.runs and not s.diffs %}<span class="badge badge-status badge-success">Intégrité OK</span>
            {% elif s.runs %}<span class="badge badge-status badge-failed">Écarts détectés</span>
            {% else %}<span class="badge badge-status badge-running">Aucune vérification</span>{% endif %}
          </div>
        </div>
      </div>
    </div>
  {% endfor %}
</div>
{% endif %}

<!-- Activité récente -->
<div class="row g-4 mt-3">
  <div class="col-lg-8">
    <div class="filters p-4">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <h6 class="mb-0 fw-bold"><i class="bi bi-clock-history me-2"></i>Dernières vérifications</h6>
        <a class="btn btn-soft btn-sm"
           href="{% url 'comparisons:runs_dashboard' %}?{% if selected_category %}category={{ selected_category }}&{% endif %}{% if selected_store %}store={{ selected_store }}&{% endif %}{% if selected_owner %}owner={{ selected_owner }}&{% endif %}start={{ start|date:'Y-m-d' }}&end={{ end|date:'Y-m-d' }}">
          Voir tout
        </a>
      </div>

      <div class="activity-list">
        {% for r in recent_runs %}
          <div class="activity-item">
            <div class="activity-icon"><i class="bi bi-rocket-takeoff"></i></div>
            <div class="activity-body w-100">
              <div class="d-flex justify-content-between align-items-center">
                <div class="fw-semibold">{{ r.config.category.name }} — {{ r.config.name }} <span class="text-muted">(#{{ r.id }})</span></div>
                <div class="small text-muted">{{ r.created_at|timesince }} ago</div>
              </div>
              <div class="mt-1 d-flex align-items-center gap-2 flex-wrap">
                <span class="mini-muted small">Créé par : <strong>{{ r.config.owner.username }}</strong></span>
                {% if r.status == "success" %}<span class="badge badge-status badge-success">success</span>
                {% elif r.status == "failed" %}<span class="badge badge-status badge-failed">failed</span>
                {% else %}<span class="badge badge-status badge-running">{{ r.status }}</span>{% endif %}
                <span class="text-muted small">Écarts: <strong>{{ r.diff_rows }}</strong></span>
                <a class="btn btn-soft btn-sm" href="{% url 'comparisons:results' r.id %}"><i class="bi bi-eye"></i> Détails</a>
                {% if r.export_csv %}<a class="btn btn-soft btn-sm" href="{{ r.export_csv }}"><i class="bi bi-filetype-csv"></i> CSV</a>{% endif %}
                {% if r.export_xlsx %}<a class="btn btn-soft btn-sm" href="{{ r.export_xlsx }}"><i class="bi bi-filetype-xlsx"></i> XLSX</a>{% endif %}
              </div>
            </div>
          </div>
        {% empty %}
          <div class="text-muted">Aucune vérification récente.</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="filters p-3">
      <h6 class="mb-2 fw-bold"><i class="bi bi-lightbulb me-2"></i>Suivi & Conseils</h6>
      <p class="small text-muted mb-2">Utilise des <strong>clés composites</strong> pour fiabiliser tes rapprochements (Référence, Date, Magasin…).</p>
      <p class="small text-muted mb-0">Après une vérification <em>sans écart</em>, la catégorie est marquée <strong>Intégrité OK</strong>.</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const labels        = {{ labels_json|safe }};
  const runsSeries    = {{ runs_series_json|safe }};
  const diffsSeries   = {{ diffs_series_json|safe }};
  const statusLabels  = {{ status_labels_json|safe }};
  const statusValues  = {{ status_values_json|safe }};

  // Line chart only if data
  {% if has_line_data %}
  new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: { labels, datasets:[
      { label: 'Runs',  data: runsSeries,  tension:.35 },
      { label: 'Écarts',data: diffsSeries, tension:.35 }
    ]},
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ position:'top' } },
      scales:{ y:{ beginAtZero:true, grid:{ color:'#eef2f7' } }, x:{ grid:{ color:'#f5f7fb' } } }
    }
  });
  {% endif %}

  // Donut only if data
  {% if has_donut_data %}
  new Chart(document.getElementById('donutChart'), {
    type:'doughnut',
    data:{ labels: statusLabels, datasets:[{ data: statusValues }] },
    options:{ responsive:true, maintainAspectRatio:false, cutout:'60%', plugins:{ legend:{ position:'bottom' } } }
  });
  {% endif %}

  // Menu magasin (préserve filtres)
  const storeItems = document.querySelectorAll('.dropdown-menu [data-store]');
  function navigateWithStore(code){
    const params = new URLSearchParams(window.location.search);
    const start = params.get('start') || '{{ start|date:"Y-m-d" }}';
    const end   = params.get('end')   || '{{ end|date:"Y-m-d" }}';
    const cat   = params.get('category') || '{{ selected_category|default_if_none:"" }}';
    const owner = params.get('owner') || '{{ selected_owner|default_if_none:"" }}';
    const p = new URLSearchParams();
    if (start) p.set('start', start); if (end) p.set('end', end);
    if (cat) p.set('category', cat);  if (owner) p.set('owner', owner);
    if (code) p.set('store', code);
    window.location.href = `${window.location.pathname}?${p.toString()}`;
  }
  storeItems.forEach(it => it.addEventListener('click', e => {
    e.preventDefault(); navigateWithStore(it.getAttribute('data-store'));
  }));
</script>

{% endblock %}
