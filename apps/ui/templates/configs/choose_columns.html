{% extends "base.html" %}
{% load crispy_forms_tags %}
{% block title %}Configurer la comparaison{% endblock %}

{% block content %}
<style>
  :root{
    --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --soft:#f8fafc;
    --brand:#2563eb; --brand2:#8b5cf6; --card:#ffffff;
  }

  /* Page wrapper */
  .screen{
    background:
      radial-gradient(1200px 600px at 10% -10%, #c7d2fe40 0, transparent 60%),
      radial-gradient(1000px 800px at 90% 0%, #ddd6fe40 0, transparent 65%),
      linear-gradient(180deg, #ffffff 0%, #fafafa 100%);
    border:1px solid #eef2f7; border-radius:22px;
    box-shadow:0 20px 50px rgba(2,6,23,.08), inset 0 1px 0 rgba(255,255,255,.6);
    padding:1rem 1rem 7rem; /* espace pour la barre d’action */
  }

  /* Step cards */
  .step-card{
    background:var(--card);
    border:1px solid #eef0f4; border-radius:18px;
    box-shadow:0 8px 22px rgba(15,23,42,.06), inset 0 1px 0 rgba(255,255,255,.6);
    margin-bottom:16px; overflow:hidden;
  }
  .step-head{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px; border-bottom:1px solid #eef0f4;
    background:linear-gradient(180deg,#ffffff,#fafbff);
  }
  .step-title{display:flex; align-items:center; gap:10px; font-weight:800; margin:0}
  .step-title .idx{
    display:inline-grid; place-items:center; width:28px; height:28px;
    border-radius:10px; background:#eef5ff; color:#2563eb; font-size:.9rem;
    border:1px solid #dbe6ff;
  }
  .step-actions{display:flex; align-items:center; gap:8px}
  .step-body{padding:16px}

  /* Inputs */
  .form-select,.form-control{
    border-radius:12px; border:1px solid #dbe1e8; padding:.65rem .9rem; transition:.18s ease
  }
  .form-select:focus,.form-control:focus{
    border-color:#a5b4fc; box-shadow:0 0 0 .25rem #dbeafe80; outline:0;
  }

  /* Preview tables */
  .tbl-wrap{max-height:44vh; border:1px solid #e8ecf3; border-radius:14px; overflow:auto}
  .preview-table{width:100%; border-collapse:separate; border-spacing:0}
  .preview-table th,.preview-table td{
    padding:8px 10px; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; max-width:220px;
    border-bottom:1px solid #eef2f7; background:#fff;
  }
  .preview-table thead th{
    position:sticky; top:0; z-index:1; background:#f8fafc; font-weight:700;
    border-bottom:1px solid #e6edf7;
  }
  .preview-table tbody tr:nth-child(odd) td{background:#fcfdff}

  /* Chips (si tu affiches des entêtes calculées) */
  .chip{display:inline-block; background:#f1f5f9; color:#334155; border-radius:999px; padding:6px 10px; margin:3px 4px; font-size:.8rem; border:1px solid #e6e9f2}

  /* Buttons */
  .btn-soft{border:1px solid #e7e9ee; background:#fbfcfe; color:#334155; border-radius:12px}
  .btn-soft:hover{background:#f2f5fb}

  /* Action bar collante */
  .action-bar{
    position:fixed; left:0; right:0; bottom:0; z-index:20;
    background:linear-gradient(180deg, rgba(255,255,255,.35) 0, #fff 45%);
    border-top:1px solid #e8ecf3; box-shadow:0 -10px 30px rgba(2,6,23,.06);
  }
  .action-inner{
    max-width:1200px; margin:0 auto; padding:.8rem 1rem; display:flex; align-items:center; gap:1rem;
    flex-wrap:wrap; justify-content:center;
  }
  .cta{
    background:linear-gradient(90deg, var(--brand), var(--brand2));
    border:none; color:#fff; border-radius:12px; padding:.9rem 1.4rem; font-weight:800;
    letter-spacing:.2px; box-shadow:0 12px 26px rgba(37,99,235,.25);
    width:100%;
  }
  @media (min-width:768px){
    .cta{width: min(560px, 60%)}
  }
  .tip{color:var(--muted); font-size:.9rem}
</style>

<div class="screen">

  <form method="post" id="cfg-form" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}

    <!-- 1) Entêtes -->
    <div class="step-card">
      <div class="step-head">
        <h6 class="step-title">
          <span class="idx">1</span> Entêtes (choisir la ligne contenant les noms de colonnes)
        </h6>
        <div class="step-actions">
          <button name="action" value="apply_headers" class="btn btn-primary btn-sm">
            <i class="bi bi-magic"></i> Appliquer
          </button>
        </div>
      </div>
      <div class="step-body">
        <div class="row g-4">
          <!-- Web1 -->
          <div class="col-lg-6">
            <h6 class="mb-2">Ligne d’entêtes — <strong>Web1</strong></h6>
            {{ form.header_web1|as_crispy_field }}

            <div class="mt-3">
              <div class="small text-muted mb-1">Aperçu des premières lignes :</div>
              <div class="tbl-wrap">
                <table class="preview-table">
                  <thead>
                    <tr>
                      {% for c in preview.web1.columns %}<th title="{{ c }}">{{ c }}</th>{% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in preview.web1.rows %}
                      <tr>
                        {% for cell in row %}<td title="{{ cell|default_if_none:'' }}">{{ cell }}</td>{% endfor %}
                      </tr>
                    {% empty %}
                      <tr><td class="text-muted" colspan="99">Aucune donnée</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Desktop -->
          <div class="col-lg-6">
            <h6 class="mb-2">Ligne d’entêtes — <strong>Desktop</strong></h6>
            {{ form.header_desktop|as_crispy_field }}

            <div class="mt-3">
              <div class="small text-muted mb-1">Aperçu des premières lignes :</div>
              <div class="tbl-wrap">
                <table class="preview-table">
                  <thead>
                    <tr>
                      {% for c in preview.desktop.columns %}<th title="{{ c }}">{{ c }}</th>{% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in preview.desktop.rows %}
                      <tr>
                        {% for cell in row %}<td title="{{ cell|default_if_none:'' }}">{{ cell }}</td>{% endfor %}
                      </tr>
                    {% empty %}
                      <tr><td class="text-muted" colspan="99">Aucune donnée</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- 2) Name -->
    <div class="step-card">
      <div class="step-head">
        <h6 class="step-title"><span class="idx">2</span> Name*</h6>
        <div class="step-actions">
          <button class="btn btn-soft btn-sm collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#blk-name">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </div>
      <div id="blk-name" class="collapse step-body">
        <label class="form-label" for="{{ form.name.id_for_label }}">Nom de la configuration</label>
        {{ form.name|as_crispy_field }}
      </div>
    </div>

    <!-- 3) Colonnes Web1 -->
    <div class="step-card">
      <div class="step-head">
        <h6 class="step-title"><span class="idx">3</span> Colonnes à garder (Web1)*</h6>
        <div class="step-actions">
          <button class="btn btn-soft btn-sm collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#blk-web1">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </div>
      <div id="blk-web1" class="collapse step-body">
        <div class="scroll-pane">
          {{ form.columns_web1|as_crispy_field }}
        </div>
      </div>
    </div>

    <!-- 4) Colonnes Desktop -->
    <div class="step-card">
      <div class="step-head">
        <h6 class="step-title"><span class="idx">4</span> Colonnes à garder (Desktop)*</h6>
        <div class="step-actions">
          <button class="btn btn-soft btn-sm collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#blk-desk">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </div>
      <div id="blk-desk" class="collapse step-body">
        <div class="scroll-pane">
          {{ form.columns_desktop|as_crispy_field }}
        </div>
      </div>
    </div>

    <!-- 5) Clés Web1 -->
    <div class="step-card">
      <div class="step-head">
        <h6 class="step-title"><span class="idx">5</span> Clés (Web1) — ordre = priorité*</h6>
        <div class="step-actions">
          <button class="btn btn-soft btn-sm collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#blk-keyw">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </div>
      <div id="blk-keyw" class="collapse step-body">
        <div class="scroll-pane">
          {{ form.join_key_web1|as_crispy_field }}
        </div>
      </div>
    </div>

    <!-- 6) Clés Desktop -->
    <div class="step-card">
      <div class="step-head">
        <h6 class="step-title"><span class="idx">6</span> Clés (Desktop) — même nombre et ordre correspondant</h6>
        <div class="step-actions">
          <button class="btn btn-soft btn-sm collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#blk-keyd">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </div>
      <div id="blk-keyd" class="collapse step-body">
        <div class="scroll-pane">
          {{ form.join_key_desktop|as_crispy_field }}
        </div>
      </div>
    </div>

    <!-- 7) Type de jointure -->
    <div class="step-card">
      <div class="step-head">
        <h6 class="step-title"><span class="idx">7</span> Type de jointure*</h6>
        <div class="step-actions">
          <button class="btn btn-soft btn-sm collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#blk-join">
            <i class="bi bi-chevron-down"></i>
          </button>
        </div>
      </div>
      <div id="blk-join" class="collapse step-body">
        {{ form.join_type|as_crispy_field }}
        <ul class="small text-muted mb-0">
          <li><strong>Left</strong> : lignes Web1 sans correspondance</li>
          <li><strong>Right</strong> : lignes Desktop sans correspondance</li>
          <li><strong>Outer</strong> : écarts des deux côtés</li>
          <li><strong>Inner</strong> : seulement les correspondances</li>
        </ul>
      </div>
    </div>

    <!-- Barre d’action globale (bouton plein largeur) -->
    <div class="action-bar">
      <div class="action-inner">
        <div class="tip d-none d-md-block">
          Vérifie les entêtes et les clés, puis lance la comparaison.
        </div>
        <button class="cta" name="action" value="save_config">
          <i class="bi bi-rocket-takeoff me-2"></i> Lancer la comparaison
        </button>
      </div>
    </div>

  </form>
</div>
{% endblock %}
