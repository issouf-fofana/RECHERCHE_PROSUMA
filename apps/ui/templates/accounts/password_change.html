{% extends "base.html" %}
{% load ui_extras %}
{% block title %}Changer le mot de passe{% endblock %}

{% block content %}

<h3 class="page-title mb-3">
  <span class="dot"><i class="bi bi-key"></i></span>
  Changer le mot de passe
</h3>

<style>
  .card-pro{background:#fff;border:1px solid #e9eef5;border-radius:18px;box-shadow:var(--ring);overflow:hidden}
  .card-pro .card-head{padding:16px 18px;border-bottom:1px solid #eef2f7;display:flex;align-items:center;justify-content:space-between}
  .card-pro .card-body{padding:50px}
  .form-pro-group{margin-bottom:14px}
  .form-pro-group label{font-weight:700;color:#0b1b46;margin-bottom:6px}
  .input-affix{position:relative}
  .input-affix input.form-control{padding-right:44px}
  .input-affix .toggle-eye{
    position:absolute;right:8px;top:50%;transform:translateY(-50%);
    border:1px solid #e6e8ef;background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer;
    color:#334155
  }
  .help-hint{color:#64748b;font-size:.9rem}
  .errorlist{list-style:none;padding-left:0;margin:.35rem 0 0}
  .errorlist li{color:#b42318;font-size:.9rem}

  /* Barre de robustesse */
  .pw-meter{height:10px;border-radius:999px;background:#eef2f7;overflow:hidden}
  .pw-meter > span{display:block;height:100%;width:0%;transition:width .25s ease}
  .pw-weak  {background:#fee2e2}
  .pw-fair  {background:#fde68a}
  .pw-good  {background:#bfdbfe}
  .pw-strong{background:#bbf7d0}

  .pw-criteria{display:grid;grid-template-columns:repeat(2, minmax(160px,1fr));gap:6px 14px;margin-top:10px}
  .pw-criteria .crit{display:flex;align-items:center;gap:8px;font-size:.92rem;color:#6b7280}
  .crit.ok{color:#0a7a3d}
  .crit i{font-size:1rem}

  /* Boutons */
  .btn-soft{border:1px solid #e5e7eb;background:#fff;color:#111827;border-radius:12px;padding:.45rem .8rem;font-weight:600}
  .btn-soft:hover{background:#f9fafb}

  /* Petit bandeau “conseil” */
  .tip{background:#f8fafc;border:1px dashed #e5e7eb;border-radius:14px;padding:10px 12px;color:#475569}
</style>

<div class="card-pro" style="max-width:720px">
  <div class="card-head">
    <div class="fw-bold"><i class="bi bi-shield-lock me-2"></i>Sécurité du compte</div>
    <span class="text-muted small">Modifie ton mot de passe régulièrement</span>
  </div>

  <div class="card-body">
    <form method="post" novalidate>
      {% csrf_token %}

      {% if form.non_field_errors %}
        <div class="alert alert-danger mb-3">{{ form.non_field_errors }}</div>
      {% endif %}

      <!-- Ancien mot de passe -->
      <div class="form-pro-group">
        <label class="form-label" for="{{ form.old_password.id_for_label }}">Mot de passe actuel</label>
        <div class="input-affix">
          {{ form.old_password|add_class:"form-control" }}
          <button class="toggle-eye" type="button" data-toggle="#{{ form.old_password.id_for_label }}" aria-label="Afficher/Masquer">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        {{ form.old_password.errors }}
      </div>

      <!-- Nouveau mot de passe -->
      <div class="form-pro-group">
        <label class="form-label" for="{{ form.new_password1.id_for_label }}">Nouveau mot de passe</label>
        <div class="input-affix">
          {{ form.new_password1|add_class:"form-control" }}
          <button class="toggle-eye" type="button" data-toggle="#{{ form.new_password1.id_for_label }}" aria-label="Afficher/Masquer">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <div class="help-hint mt-1">Utilise un mot de passe robuste (idéalement 12 caractères ou plus).</div>
        {{ form.new_password1.errors }}

        <!-- Indicateur de robustesse -->
        <div class="pw-meter mt-3" aria-hidden="true"><span id="pwBar" class="pw-weak"></span></div>
        <div class="pw-criteria" id="pwCrit">
          <div class="crit" data-rule="len"><i class="bi bi-dot"></i><span>Au moins 12 caractères</span></div>
          <div class="crit" data-rule="upper"><i class="bi bi-dot"></i><span>Une majuscule</span></div>
          <div class="crit" data-rule="lower"><i class="bi bi-dot"></i><span>Une minuscule</span></div>
          <div class="crit" data-rule="digit"><i class="bi bi-dot"></i><span>Un chiffre</span></div>
          <div class="crit" data-rule="spec"><i class="bi bi-dot"></i><span>Un caractère spécial</span></div>
        </div>
      </div>

      <!-- Confirmation -->
      <div class="form-pro-group">
        <label class="form-label" for="{{ form.new_password2.id_for_label }}">Confirmation</label>
        <div class="input-affix">
          {{ form.new_password2|add_class:"form-control" }}
          <button class="toggle-eye" type="button" data-toggle="#{{ form.new_password2.id_for_label }}" aria-label="Afficher/Masquer">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        {{ form.new_password2.errors }}
      </div>

      <div class="tip mb-3">
        <i class="bi bi-lightbulb me-2"></i>
        Astuce : tu peux utiliser une <strong>phrase de passe</strong> (ex. 3–4 mots + chiffres) — plus facile à retenir et très robuste.
      </div>

      <div class="d-flex gap-2">
        <a class="btn btn-soft" href="{% url 'accounts:profile' %}">Annuler</a>
        <button class="btn btn-primary" type="submit">
          <i class="bi bi-check2-circle me-1"></i> Mettre à jour
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Afficher/Masquer
  document.querySelectorAll('.toggle-eye').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sel = btn.getAttribute('data-toggle');
      const inp = document.querySelector(sel);
      if(!inp) return;
      if (inp.getAttribute('type') === 'password') {
        inp.setAttribute('type', 'text'); btn.innerHTML = '<i class="bi bi-eye-slash"></i>';
      } else {
        inp.setAttribute('type', 'password'); btn.innerHTML = '<i class="bi bi-eye"></i>';
      }
    });
  });

  // Robustesse & critères
  const pw1   = document.getElementById('{{ form.new_password1.id_for_label }}');
  const bar   = document.getElementById('pwBar');
  const crits = document.querySelectorAll('#pwCrit .crit');

  function scorePassword(p){
    // Règles simples: longueur, diversité de caractères
    const hasLower = /[a-z]/.test(p);
    const hasUpper = /[A-Z]/.test(p);
    const hasDigit = /\d/.test(p);
    const hasSpec  = /[^A-Za-z0-9]/.test(p);
    const long12   = p.length >= 12;

    // Màj critères
    const map = {lower:hasLower, upper:hasUpper, digit:hasDigit, spec:hasSpec, len:long12};
    crits.forEach(c=>{
      const r = c.getAttribute('data-rule');
      c.classList.toggle('ok', !!map[r]);
      c.querySelector('i').className = map[r] ? 'bi bi-check-circle' : 'bi bi-dot';
    });

    // Score (0-5)
    let score = 0;
    score += long12 ? 1 : 0;
    score += hasLower ? 1 : 0;
    score += hasUpper ? 1 : 0;
    score += hasDigit ? 1 : 0;
    score += hasSpec  ? 1 : 0;
    return score;
  }

  function renderMeter(score){
    const pct = [0, 20, 40, 70, 85, 100][score] || 0;
    bar.style.width = pct + '%';
    bar.className = '';
    if (score <= 1)      bar.classList.add('pw-weak');
    else if (score == 2) bar.classList.add('pw-fair');
    else if (score == 3) bar.classList.add('pw-good');
    else                 bar.classList.add('pw-strong');
  }

  if (pw1) {
    pw1.addEventListener('input', ()=>{
      const s = scorePassword(pw1.value);
      renderMeter(s);
    });
    // Init si le navigateur remplit
    setTimeout(()=>{ const s = scorePassword(pw1.value||''); renderMeter(s); }, 50);
  }
</script>

{% endblock %}
