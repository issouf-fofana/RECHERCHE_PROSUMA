{% extends "base.html" %}
{% block title %}Mes comparatifs{% endblock %}
{% block content %}

<h3 class="page-title mb-3">
  <span class="dot"><i class="bi bi-columns-gap"></i></span>
  Mes comparatifs
</h3>

<style>
  :root{
    --ink:#0f172a; --ink-2:#1f2937;
    --muted:#6b7280; --line:#e5e7eb; --soft:#f8fafc;
    --card:#ffffff; --ring:0 10px 26px rgba(2,6,23,.06);
    --radius:18px; --brand:#2563eb;
  }
  .page-title{display:flex;align-items:center;gap:.6rem;font-weight:800;color:var(--ink)}
  .page-title .dot{display:grid;place-items:center;width:36px;height:36px;border-radius:12px;background:#e0ecff;color:#1e40af}

  /* ====== KPI ====== */
  .metrics-grid{display:grid;gap:12px;grid-template-columns:repeat(12,1fr)}
  .metric-card{grid-column:span 3;position:relative;background:#fff;border-radius:var(--radius);border:1px solid #e9eef5;box-shadow:var(--ring);padding:16px 16px 14px 18px;min-height:120px;overflow:hidden}
  @media (max-width:991.98px){.metric-card{grid-column:span 6}}
  @media (max-width:575.98px){.metric-card{grid-column:span 12}}
  .metric-card::after{content:"";position:absolute;inset:-1px auto -1px -1px;width:8px;border-radius:var(--radius) 0 0 var(--radius)}
  .metric-card.ac-blue::after   {background:linear-gradient(180deg,#3b82f6,#1d4ed8)}
  .metric-card.ac-green::after  {background:linear-gradient(180deg,#16a34a,#0f7a36)}
  .metric-card.ac-pink::after   {background:linear-gradient(180deg,#db2777,#f43f5e)}
  .metric-card.ac-orange::after {background:linear-gradient(180deg,#f59e0b,#f97316)}
  .metric-card .icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;margin-bottom:8px}
  .icon.blue{background:linear-gradient(135deg,#3b82f6,#2563eb)}
  .icon.green{background:linear-gradient(135deg,#16a34a,#22c55e)}
  .icon.pink{background:linear-gradient(135deg,#db2777,#f43f5e)}
  .icon.orange{background:linear-gradient(135deg,#f59e0b,#f97316)}
  .metric-card .value{font-weight:800;font-size:1.9rem;line-height:1;color:var(--ink)}
  .metric-card .label{color:#6b7280;font-size:.95rem;margin-top:6px}

  /* ====== Filtres ====== */
  .filters{background:var(--card);border:1px solid #e9eef5;border-radius:var(--radius);box-shadow:var(--ring);padding:14px}
  .filters .form-label{font-weight:700;color:var(--ink-2)}
  .btn-soft{border-radius:12px;border:1px solid #e5e7eb;background:#fff;color:#111827;padding:.42rem .7rem;font-weight:600}
  .btn-soft:hover{background:#f2f4f8}
  .btn-icon{padding:.35rem .55rem}

  /* ====== Tableau ====== */
  .table-wrap{background:#fff;border:1px solid #e9eef5;border-radius:16px;box-shadow:var(--ring);overflow:hidden}
  .table-modern thead th{position:sticky;top:0;z-index:2;background:#f3f6ff;color:#0b1b46;font-weight:700;border-bottom:0}
  .table-modern tbody tr{border-top:1px solid #f0f2f6}
  .table-modern tbody tr:hover{background:#fbfdff}
  .table-modern td,.table-modern th{vertical-align:middle}

  .badge-status{border-radius:999px;padding:.2rem .55rem;font-weight:700;letter-spacing:.2px}
  .badge-success{background:#ecfdf5;color:#047857;border:1px solid #bbf7d0}
  .badge-failed{ background:#fef2f2;color:#b91c1c;border:1px solid #fecaca}
  .badge-running{background:#eef5ff;color:#1e40af;border:1px solid #d6e3ff}

  /* Groupes d’actions */
  .btn-group-soft .btn{border-color:#e6e8ee}
  .btn-group-soft .btn:hover{background:#f6f8fc}
</style>

<!-- Cartes KPI -->
<div class="metrics-grid mb-3">
  <div class="metric-card ac-blue">
    <div class="icon blue"><i class="bi bi-collection"></i></div>
    <div class="value">{{ stats.total }}</div>
    <div class="label">Runs totaux</div>
  </div>
  <div class="metric-card ac-green">
    <div class="icon green"><i class="bi bi-check2-circle"></i></div>
    <div class="value">{{ stats.success }}</div>
    <div class="label">Succès</div>
  </div>
  <div class="metric-card ac-pink">
    <div class="icon pink"><i class="bi bi-x-circle"></i></div>
    <div class="value">{{ stats.failed }}</div>
    <div class="label">Échecs</div>
  </div>
  <div class="metric-card ac-orange">
    <div class="icon orange"><i class="bi bi-graph-up-arrow"></i></div>
    <div class="value">{{ stats.diffs }}</div>
    <div class="label">Écarts cumulés</div>
  </div>
</div>

<!-- Filtres -->
<div class="filters mb-2">
  <form method="get" class="row g-2">
    <div class="col-12 col-md-6 col-xl-2">
      <label class="form-label">Catégorie</label>
      <select name="category" class="form-select">
        <option value="">Toutes</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {% if selected.category == c.id|stringformat:"s" %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-6 col-xl-2">
      <label class="form-label">Configuration</label>
      <select name="config" class="form-select">
        <option value="">Toutes</option>
        {% for c in configs %}
          <option value="{{ c.id }}" {% if selected.config == c.id|stringformat:"s" %}selected{% endif %}>
            {{ c.name }} — {{ c.category.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-6 col-xl-1">
      <label class="form-label">Statut</label>
      <select name="status" class="form-select">
        <option value="">Tous</option>
        {% for s in status_choices %}
          <option value="{{ s }}" {% if selected.status == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-md-6 col-xl-2">
      <label class="form-label">Magasin</label>
      <select name="store" class="form-select">
        <option value="">Tous</option>
        {% for s in stores %}
          <option value="{{ s.code }}" {% if selected.store == s.code %}selected{% endif %}>
            {% if s.code %}{{ s.code }}{% else %}-{% endif %}{% if s.name %} — {{ s.name }}{% endif %}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-xl-3 d-flex justify-content-xl-end align-items-end gap-2 mt-1">
      <button class="btn btn-primary" type="submit">Filtrer</button>
      <a href="{% url 'comparisons:runs_dashboard' %}" class="btn btn-soft">Réinitialiser</a>
    </div>
  </form>
</div>

<!-- Tableau -->
<div class="table-wrap">
  <div class="table-responsive">
    <table class="table table-modern table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>#</th>
          <th>Date</th>
          <th>Magasin</th>
          <th>Catégorie</th>
          <th>Configuration</th>
          <th>Statut</th>
          <th>Écarts</th>
          <th>Lignes</th>
          <th>Résultats</th>
          <th>Actions</th>
          <th>Exports</th>
        </tr>
      </thead>
      <tbody>
      {% for r in runs %}
        <tr>
          <td class="text-muted">#{{ r.id }}</td>
          <td>{{ r.created_at|date:"Y-m-d H:i" }}</td>

          <td>
            {% if r.dataset_web1 %}
              {% if r.dataset_web1.store_code or r.dataset_web1.store_name %}
                {{ r.dataset_web1.store_code|default:"-" }}{% if r.dataset_web1.store_name %} — {{ r.dataset_web1.store_name }}{% endif %}
              {% else %}-{% endif %}
            {% elif r.dataset_desktop %}
              {% if r.dataset_desktop.store_code or r.dataset_desktop.store_name %}
                {{ r.dataset_desktop.store_code|default:"-" }}{% if r.dataset_desktop.store_name %} — {{ r.dataset_desktop.store_name }}{% endif %}
              {% else %}-{% endif %}
            {% else %}-{% endif %}
          </td>

          <td>{{ r.config.category.name }}</td>
          <td class="fw-semibold">{{ r.config.name }}</td>

          <td>
            {% if r.status == "success" %}
              <span class="badge badge-status badge-success">success</span>
            {% elif r.status == "failed" %}
              <span class="badge badge-status badge-failed">failed</span>
            {% else %}
              <span class="badge badge-status badge-running">{{ r.status }}</span>
            {% endif %}
          </td>

          <td><strong>{{ r.diff_rows }}</strong></td>
          <td>{{ r.total_rows }}</td>

          <td>
            <a class="btn btn-soft btn-sm" href="{% url 'comparisons:results' r.id %}">
              <i class="bi bi-eye"></i> Voir
            </a>
          </td>

          <td class="text-nowrap">
            {% if request.user.is_staff or r.config.owner_id == request.user.id %}
              <div class="btn-group btn-group-soft" role="group" aria-label="Actions">
                <button type="button" class="btn btn-soft btn-sm js-edit-run" title="Modifier"
                        data-run-id="{{ r.id }}" data-run-notes="{{ r.message|default_if_none:''|escape }}">
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button type="button" class="btn btn-soft btn-sm text-danger js-del-run" title="Supprimer"
                        data-run-id="{{ r.id }}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            {% else %}
              <span class="text-muted small">—</span>
            {% endif %}
          </td>

          <td class="text-nowrap">
            {% if r.export_csv %}
              <a class="btn btn-soft btn-sm" href="{{ r.export_csv }}"><i class="bi bi-filetype-csv"></i> CSV</a>
            {% endif %}
            {% if r.export_xlsx %}
              <a class="btn btn-soft btn-sm" href="{{ r.export_xlsx }}"><i class="bi bi-filetype-xlsx"></i> XLSX</a>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="11" class="text-muted py-4 text-center">Aucun run pour l’instant.</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- ========= Modale EDIT ========= -->
<div class="modal fade" id="editRunModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" id="editRunForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Modifier le comparatif</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <label class="form-label">Notes</label>
          <textarea name="message" id="editMessage" class="form-control" rows="5" placeholder="Saisir vos notes…"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-primary" type="submit">Enregistrer</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- ========= Modale DELETE ========= -->
<div class="modal fade" id="deleteRunModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="post" id="deleteRunForm">
      {% csrf_token %}
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title text-danger"><i class="bi bi-trash me-2"></i>Supprimer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <p id="deleteRunText" class="mb-0">Supprimer ce comparatif ?</p>
          <small class="text-muted">Cette action est irréversible.</small>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Annuler</button>
          <button class="btn btn-danger" type="submit">Supprimer</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  if (!window.bootstrap) return;

  const editModal = new bootstrap.Modal(document.getElementById('editRunModal'));
  const delModal  = new bootstrap.Modal(document.getElementById('deleteRunModal'));

  // EDIT
  document.querySelectorAll('.js-edit-run').forEach(btn => {
    btn.addEventListener('click', () => {
      const id    = btn.getAttribute('data-run-id');
      const notes = btn.getAttribute('data-run-notes') || '';
      document.getElementById('editMessage').value = notes;

      const form = document.getElementById('editRunForm');
      form.action = "{% url 'comparisons:run_edit' 0 %}".replace('/0/', `/${id}/`);
      editModal.show();
    });
  });

  // DELETE
  document.querySelectorAll('.js-del-run').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.getAttribute('data-run-id');
      document.getElementById('deleteRunText').innerText = `Supprimer le comparatif #${id} ?`;

      const form = document.getElementById('deleteRunForm');
      form.action = "{% url 'comparisons:run_delete' 0 %}".replace('/0/', `/${id}/`);
      delModal.show();
    });
  });
});
</script>

{% endblock %}
